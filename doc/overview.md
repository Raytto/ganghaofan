# 罡好饭小程序 · 项目概览

本文件用于快速理解本工程的整体结构、主要页面与组件、关键数据流与约定，方便后续迭代与维护。
关于主题与状态色的完整规范，请参考《doc/color_std.md》。
有重要或相关的修改时请同时修改本文档。

## 项目简介
- 前端：微信小程序（TypeScript，Skyline 渲染），深色主题定制。
- 后端：FastAPI（Python）+ DuckDB，JWT 鉴权（通过 wx.login 交换 token）。
- 目标：提供“工作日订餐”能力，首页展示月历，支持上下滑动切月与点击进入下单页。

## 目录结构（摘录）
```
client/
  miniprogram/
    app.json           # 小程序全局配置（深色、custom 导航、自定义 tabBar）
    app.ts             # 全局初始化（登录）
    app.wxss           # 全局样式（暗色背景 #1B1B1B、基础文字 #C9D1D9）
    custom-tab-bar/    # 自定义底部栏（index.js 为必需）
    components/
      navigation-bar/   # 自定义导航条（暗色默认）
      publish-dialog/   # 发布/编辑餐次弹窗（组件化）
      order-dialog/     # 下单/修改/查看弹窗（组件化）
    pages/
      index/           # 首页（日历）
      order/           # 下单页（根据 meal_id 下单）
      admin/           # 管理页（管理员可见）
      profile/         # 个人中心（所有用户）
      logs/            # 日志页（占位）
    utils/
      api.ts           # 网络封装、登录与日历 API（含按 open_id 作用域的 DB Key 存取）
      passphrase.ts    # 口令设置弹窗的共用助手（confirm-only + 失败自动重试）
  typings/             # TS 类型声明
server/                # FastAPI 服务（日历、餐次、鉴权等）
  config/
    passphrases.json   # 口令 → 数据库 Key 映射（白名单）
    dev_mock.json      # 开发期 mock 登录配置（可选）
```

## 全局主题与样式
- 主题模式：支持深色模式（默认）与浅色模式切换，通过"我的"页面控制。
- 深色模式：页面底色 `#1B1B1B`；标题栏背景 `#1B1B1B`；日历单元格底 `#131314`。
- 浅色模式：页面底色 `#FFFFFF`；标题栏背景 `#FFFFFF`；日历单元格底 `#F8F9FA`。
- 文字：深色模式主文字 `#C9D1D9`，次级说明 `#8b949e`；浅色模式主文字 `#202124`，次级说明 `#9AA0A6`；错误红深色 `#f85149`，浅色 `#D93025`。
- 边框：深色模式浅色分隔 `rgba(255,255,255,0.08~0.12)`；浅色模式深色分隔 `rgba(0,0,0,0.08~0.12)`。
- 组件：navigation-bar 根据主题动态调整背景和文字色，返回箭头跟随 `currentColor`。
- Skyline 兼容：避免 CSS Grid/Gap/复杂滤镜，使用 Flex 布局；注意安全区与滚动捕获。

## 鉴权与网络
- 登录流程：
  1) 首次进入调用 `wx.login` 获取 `code`；
  2) POST `/auth/login` 换取 `token`，持久化到 `Storage`；
  3) 后续请求在 `Authorization: Bearer <token>` 头里携带。
- API 封装：`miniprogram/utils/api.ts`
  - `BASE_URL`: `http://127.0.0.1:8000/api/v1`
  - `loginAndGetToken()`：登录并缓存 token。
  - `getCalendar(month)`：获取单月日历。
  - `getCalendarBatch(months: string[])`：批量获取多月（首页一次取前/当前/后 3 个月窗口）。
  - 多数据库路由：前端在请求头携带 `X-DB-Key`，由服务器基于该 Key 选择 DuckDB 文件。
  - DB Key 按用户作用域：小程序端以 `open_id` 为粒度在本地存储 `db_key_map`，不同用户互不干扰；登录成功（设置新 token）时会清空缓存的 `current_open_id`，并通过 `/users/me` 拉取与持久化当前 `open_id`。
  - 口令解析：前端调用 `POST /env/resolve { passphrase }` 换取 `key`，失败返回 400 并提示“口令没对上”。

## 多数据库与口令（2025-08）
- 白名单映射：`server/config/passphrases.json` 定义“口令 → DB Key”的映射。后端严格校验，未配置的口令一律 400 “口令没对上”。
- 共用弹窗：新增 `utils/passphrase.ts` 暴露 `promptPassphrase()`，统一弹窗样式与交互：
  - 仅一个“确定”按钮（不显示“取消”）。
  - 为空或无效口令时，toast 提示并自动再次弹出，直至输入合法。
  - 成功后持久化 DB Key 并提示“已设置口令”。
- 首次提示策略：
  - 首页（index）：页面挂载时若无 DB Key，先弹口令，不加载数据；设置成功后重置日历缓存并基于新库预加载 3 个月窗口。
  - 个人中心（profile）：进入页面若无 DB Key，同样弹出口令；设置成功后更新页面展示。
- 请求路由：所有 API 调用自动携带当前用户作用域下的 `X-DB-Key`。
- 服务端启动：读取映射，启动阶段主动初始化默认库与所有已配置 DB（不存在则创建并建表）。
- 开发 Mock：
  - `server/config/dev_mock.json` 或环境变量开启 mock 登录（固定/或每次唯一的 open_id，字段：`mock_enabled`、`open_id`、`nickname`、`unique_per_login`）。
  - `GET /env/mock` 返回当前 mock 配置，前端“个人中心”可据此补齐昵称展示。
  - 用户首次访问的创建逻辑做了幂等处理，避免并发下唯一约束导致 500。

## 页面一览

### 1) 首页：`pages/index`
- 作用：展示按“工作日（周一至周五）”排列的周视图；以“周”为单位滚动，预加载 9 周（上 3 周/当前 3 周/下 3 周），吸附翻页一次滑动 3 周；点击某一时段进入下单或打开发布弹窗（管理员）。
- 文件：
  - `index.wxml`：
    - 顶部 Header：
      - 左侧：若具备管理员权限（`canAdmin`），显示“管/用”切换按钮（`adminView`）；其后为 Today 按钮（中文今日标签）。
      - 右侧：口号“和罡子哥一起健康每一天”。
    - 周标题行：仅显示 `星期一 … 星期五`，两侧保留周末“空占位”以与下方 7 列对齐（周末不显示文字）。
    - 日历视图：`cal-viewport` 容器内堆叠 9 个周块，`cal-track` 通过 `translateY` 实现平滑吸附；进入页面后将“含今天的那一周”定位在中间一屏，滑动一次跨越 3 周。
    - 管理员视图切换：Today 左侧的“管/用”按钮与管理页开关保持一致并持久化到本地存储。
  - 发布弹窗：使用组件 `<publish-dialog />`。在管理员视图下，点击工作日且该时段未发布餐食，会弹出“发布罡好饭”对话框，包含：
      - 日期/时段：只读，形如 `YYYY-MM-DD · 午餐/晚餐`；
      - 描述：多行文本（textarea）。
      - 价格（元）：整数，默认 20，带“±5”按钮（最低 0）。
      - 限制（份）：整数，默认 50，带“±10”按钮（最低 1）。
      - 可选项（名称和价格）：支持多项，名称文本；价格为整数，带“±1”按钮，允许为负；“添加”按钮右对齐贴边。
  - 按钮：创建态仅“发布”。编辑态根据状态提供“修改/锁定/撤单”；只读态（已完成）不提供操作。关闭方式为右上角“×”或点击遮罩。
      - 说明：单人限购设置已移除，后端强制“每用户每餐仅 1 单”。
  - `index.wxss`：
    - 深色主题、分隔线、slot 状态色；
    - 7 列：周一至周五各 18% 宽，周末（周日/周六）各 5% 宽并固定在两侧；
    - “今日”日期圆形底：20×20，背景 `#A8C7FA`，文字 `#131314`；日期字体 10px。
  - `index.ts`（关键逻辑）：
    - 9 周窗口缓存与吸附滚动；进入时测量视口并将“本周”居中；
    - 触摸事件：日历区域内捕获 move，允许子元素 tap；
    - `onTapSlot`：用户视图进入下单；管理员视图点击未发布则打开发布弹窗；
  - 口令：若当前用户未设置 DB Key，则先弹出“口令设置”对话框（确认后才加载数据）。
  - `onPublishSubmit()`：创建态调用 `POST /meals`；编辑态根据是否为“危险修改”调用 `POST /meals/{id}/repost`（取消并退款所有已订）或 `PUT /meals/{id}`（直接修改）。成功后更新本地周数据与缓存，关闭弹窗。
  - 数据字段：`weeks9/trackY/trackBase/trackAnimate/adminView/canAdmin/showPublish/publishForm` 等。

### 2) 下单页：`pages/order`
- 作用：根据 `meal_id` 拉取餐次详情；默认数量 1 下单（示例）。
- 后续可扩展：选项勾选、价格计算、库存与限购校验、下单反馈与跳转。

### 3) 个人中心：`pages/profile`
- 作用：用户个人信息管理与设置。
- 功能：
  - 深色模式开关：用户可在此页面切换深色/浅色模式，偏好持久化存储。
  - 用户信息与余额：展示 `user_id/open_id/nickname` 与余额；后端并发安全，异常不致崩溃。
  - 口令设置：复用共用弹窗；无 DB Key 时自动提示；设置成功后更新本页 DB Key 显示。
- 实现：通过全局状态管理主题切换，影响整个应用的配色方案。

### 4) 日志页：`pages/logs`
- 用于调试或展示历史（当前为占位）。

## 组件：`components`

### navigation-bar
- 属性：
  - `title` 文本；`background` 背景色（默认 `#1B1B1B`）；`color` 字体色（默认 `#C9D1D9`）；
  - `back` 是否显示返回；`delta` 返回层级；`loading` 显示加载；
  - 槽位：`left/center/right` 可插槽定制。
- 样式：
  - 跟随安全区；返回箭头使用 `currentColor`，与文字色一致；
  - iOS/Android 高度兼容；`styleIsolation: apply-shared` 允许继承部分样式。
- 使用：`<navigation-bar title="罡好饭" back="{{false}}" background="#1B1B1B" color="#C9D1D9" />`

### publish-dialog
- 作用：承载“发布/编辑餐次”弹窗 UI 与交互外壳（表单、按钮、只读与危险修改提示）。
- 属性：
  - `show` 是否可见；`mode` `'create'|'edit'`；`form` 当前表单数据；`original` 原餐次详情；`readonly` 是否只读；`needsRepost` 是否危险修改。
- 事件：
  - `close` 关闭；`input`/`number`/`adjust` 表单变更；`addoption`/`removeoption`/`optioninput`/`adjustoption` 选项变更；
  - `submit` 提交；`cancelmeal` 撤单；`lockmeal` 锁定。
- 使用：在 `pages/index` 绑定到对应的页面方法（页面仍负责实际业务与 API 调用）。

### order-dialog
### 口令设置弹窗（共用）
- 入口：`utils/passphrase.ts` 的 `promptPassphrase()`；被首页与个人中心复用。
- 交互：
  - 仅保留底部“确定”按钮；无“取消”。
  - 输入为空或无效时，toast 提示（分别为“请输入口令”/“口令没对上”）并自动再次弹出。
  - 输入合法时，调用 `/env/resolve` 并保存 DB Key，toast “已设置口令”。

- 作用：承载“下单/修改/查看”弹窗 UI。
- 属性：`show` 是否可见；`detail` 详情（包含 date/slot/ordered_qty/capacity/options/action/readonlyMsg）。
- 事件：`close` 关闭；`create` 下单；`update` 修改；`cancelorder` 撤单。

## 自定义底部栏（TabBar）
- 位置与实现：`miniprogram/custom-tab-bar/`（注意：必须存在 `index.js`，小程序不识别 TS 版本）。
- 配置：`app.json` 中开启 `{"tabBar": { "custom": true, ... }}`，并在 `list` 中配置页面。
- 角色控制：
  - 读取 `wx.getStorageSync('user_role')` 判断是否为 `'admin'`；
  - 管理员显示“管理、个人中心”两栏；普通用户仅显示“个人中心”。
- 相关页面：
  - `pages/admin/index`（管理页，占位）；
  - `pages/profile/index`（个人中心，占位）。

## 后端能力（摘要）
- 接口前缀：`/api/v1`
- 主要路由：
  - `POST /auth/login`：使用小程序 `code` 交换 `token`；
  - `GET /calendar?month=YYYY-MM`：单月餐次；
  - `GET /calendar/batch?months=YYYY-MM,YYYY-MM,...`：多月批量；
  - `GET /meals/{meal_id}`：餐次详情。
  - `POST /env/resolve`：解析口令为 DB Key（严格白名单，失败 400）。
  - `GET /env/mock`：返回开发期 mock 配置（是否开启、昵称、open_id 策略等）。
  - `POST /meals`（管理员）：创建餐次。请求体：`{ date, slot, title?, description?, base_price_cents, options:[{id,name,price_cents}], capacity }`（单人限购移除，后端下单逻辑限制每人每餐仅 1 单）。
  - `PUT /meals/{meal_id}`（管理员）：在 `status='published'` 下直接修改餐次（不影响已订订单）。
  - `POST /meals/{meal_id}/repost`（管理员）：危险修改路径，更新餐次字段并取消/退款当前餐次下所有“已订”订单；保持同一 `meal_id`。
  - `POST /meals/{meal_id}/lock`（管理员）：锁定本餐，冻结修改与用户下单；
  - `POST /meals/{meal_id}/complete`（管理员）：将已锁定餐次标记为完成；
  - `POST /meals/{meal_id}/cancel`（管理员）：撤单并退款所有活跃订单，餐次状态变为 canceled。
- 业务规则（当前/计划）：
  - 下单即扣款；取消退回余额；修改=取消+重下；允许小额负数；管理员白名单（端上可通过开关控制）。

## 弹窗风格标准（基于“发布罡好饭”）

本节为全局弹窗的样式与交互规范，后续新弹窗应尽量复用。

### 结构与尺寸
- 遮罩：全屏 `rgba(0,0,0,0.6)`，可点击遮罩关闭；禁止背景滚动。
- 容器：宽度 92%，最大宽度 560px；背景 `#151A21`；前景文字 `#C9D1D9`；边框 `1px rgba(255,255,255,0.08)`；圆角 14px；投影 `0 10px 30px rgba(0,0,0,0.5)`；基础字号 12px。
- 头部：内边距 `12px 16px`；标题居中 16px/600；右上角“×”按钮 28×28，`top:8px; right:12px`；底部细分隔线。
- 正文：内边距 `14px 16px`；最大高度 62vh，超出滚动。
- 底部：内边距 `12px 16px`；右对齐按钮，按键间距 12px；顶部细分隔线。

### 表单布局
- 行：使用水平 Flex；`.row` 对齐居中、间距 8px、底边距 10px；
- 标签：`.lbl` 固定宽度 72px，颜色 `#8B949E`；
- 输入项：
  - 文本输入 `.inp` 高 34px；文本域 `.ta` 最小高 72px；均背景 `#0D1117`，边框 `rgba(255,255,255,0.12)`，圆角 8px；
  - 数字输入 `.inp-num` 宽 76px、高 34px、行高 34px 居中对齐；
  - 数值调整按钮 `.btn-adjust` 高 28px、最小宽 40px，背景 `#414345`，文字 `#C4C7C5`；
- 选项区：
  - 标题区使用独立容器 `.opts-head`（不复用 `.row`），左侧标题文本“可选项(名称和价格)”，右侧“添加”按钮通过 `margin-left: auto` 右贴，必要时 `margin-right: -2px` 细调。
  - 选项行 `.opt-item`：左侧名称输入（`flex:1`，高 34px），右侧价格区（数字输入宽 38px，带“±1”按钮），尾部“删除”按钮。

### 文案与交互
- 标题：动词+对象，尽量简短，如“发布罡好饭”。
- 关闭：不提供“取消”大按钮；通过右上角“×”或点击遮罩关闭。
- 校验：
  - 价格（元）默认 20，步进 ±5，最小 0；
  - 限制（份）默认 50，步进 ±10，最小 1；
  - 选项价格步进 ±1，允许为负；
  - 必填项缺失或非法值时阻止提交并 `toast` 提示。
- 提交：仅一个主按钮“发布”（`.btn-primary` 背景 `#A8C7FA`、文字 `#062E6F`）。成功后关闭弹窗并刷新当前视图；失败 `toast`。

### 适配与无障碍
- 触控：按钮与输入控件的可点区域≥28×28；
- 文本：数字内容垂直居中；长文案截断或换行；
- 对比：深色背景上文字与控件均达成可读对比度；
- Skyline：优先使用 Flex，避免 Grid/复杂滤镜/粘性定位等可能影响性能的特性。

## 兼容性与约定
- 语法：避免可选链（`?.`）和动态 `import()` 以兼容真机；
- 布局：使用 Flex，避免 CSS Grid 与不支持的属性；
- 滚动：日历区域独立捕获 `touch`，防止整页滚动；
- 时间：统一 `YYYY-MM` / `YYYY-MM-DD`；周起始为周一；
- 多库：所有请求附带 `X-DB-Key`；DB Key 存储按 `open_id` 作用域隔离，切换用户不会串库。
- 颜色：
  - 页面背景 `#1B1B1B`；标题栏 `#1B1B1B`；日历格 `#131314`；
  - 主文字 `#C9D1D9`，次级 `#8b949e`；
  - slot 状态：
    - none: `#262b31 / #8b949e`
    - published: 背景 `rgba(35,134,54,0.15)` / 文本 `#3fb950`
    - locked: 背景 `rgba(187,128,9,0.18)` / 文本 `#d29922`
    - completed: `#21262d / #8b949e`
    - canceled: `#2d333b / #8b949e`（删除线）

## 常见改动指引
- 新增页面：
  1) 在 `app.json.pages` 注册；
  2) 创建 `pages/<name>/{index.wxml, index.ts, index.wxss, index.json}`；
  3) 复用 `navigation-bar` 以保持统一风格。
- 新增接口：
  1) 后端新增路由；
  2) 在 `utils/api.ts` 添加封装（带 token）；
  3) 页面内调用并处理 `loading/tip` 与错误态。
- 调整主题：
  - 全局：`app.json` 的 `window.backgroundColor`、`app.wxss`；
  - 导航：`components/navigation-bar` 默认属性；
  - 页面：各自 `*.wxss`（遵循深色配色）。
- 调整日历：
  - 仅工作日：由 `buildGrid` 控制；
  - 行高与可视高度：`measureViewportAndCenter` -> `blockH`；
  - 滑动阈值：`onCalTouchEnd` 中按 `blockH * 0.3` 计算。

## 调试与排错小贴士
- 服务未启动时，首页会显示“加载失败”；先启动后端再进入；
- 如登录异常，清理 `Storage` 的 `auth_token` 并重试；
- 若真机出现语法错误，检查是否混入了可选链、动态 import 或不支持的 CSS 属性；
- 样式问题优先用 Flex；必要时减少内边距/行间距以适配小屏。

## 后续路线（建议）
- 首页：
  - 高亮“今天”、展示“已下单/余量/售罄”等徽标；
  - 月缓存与预取，减少快速滑动时的请求；
- 下单：
  - 选项组件（单选/多选/加价）、实时价格计算、库存/限购校验、提交结果页；
- 管理：
  - 发布/编辑/锁定/完成/取消 UI；管理员白名单。

---
若需要在某处扩展/重构，请优先更新本概览，保持页面与数据流描述与代码一致，便于后续协作。

## 餐次状态与交互（午/晚）

展示分三行，颜色依据餐次状态与“我是否已订”计算；点击行为在用户模式与管理模式下不同。

### 文本三行
1) 第一行：“午餐”/“晚餐”。
2) 第二行：本餐状态：未发布 / 抢饭进行时 / 已订完 / 已锁定 / 已结束。
3) 第三行：辅助信息：如“剩X”（当可订）或“已订/未订”。整体三行文本居中显示。

### 颜色规则（忽略月份/周末逻辑）
- 已发布且可订（left>0），我未订：填充 F6BF26，文字 131314
- 已发布且可订（left>0），我已订：填充 F4511E，文字 131314
- 已发布且被订完（left<=0），我未订：填充 616161，文字 C4C7C5
- 已发布且被订完（left<=0），我已订：填充 F4511E，文字 131314
- 已锁定，且我已订：填充 8E24AA，文字 131314
- 已锁定，且我未订：填充 616161，文字 C4C7C5
- 已完成，且我未订：填充 616161，文字 C4C7C5
- 已完成，且我已订：填充 039BE5，文字 131314
- 未发布：填充 616161，文字 C4C7C5

说明：以上配色用于首页餐次三行块的底色与文字色，覆盖并优先于前文“slot 状态颜色”的通用示例。

### 用户模式点击逻辑
- 可订且我未订：弹“点餐弹窗（下单）”，包含：关闭、日期、“已订 X/Y”、描述、可选项（如“鸡腿+3元”）可选择、特殊备注、下单按钮。
- 可订且我已订：弹“点餐弹窗（修改）”，包含：关闭、日期、“已订 X/Y”、描述、可选项、特殊备注、确定修改、撤单按钮。
- 订完且我未订：弹“仅查看餐食”，选项锁定，显示“哦豁，被订完了，下次加油”。
- 订完且我已订：弹“可修改订单”。
- 已锁定且我已订：弹“仅查看订单”，选项锁定，保持我的订单一致，显示“已锁定”。
- 已锁定且我未订：弹“仅查看餐食”，选项锁定，显示“哦豁，已锁定，你错过了，下次加油”。
- 已完成且我未订：弹“仅查看餐食”，选项锁定，显示“本餐已结束”。
- 已完成且我已订：弹“仅查看订单”，选项锁定，显示“本餐已完成”。
- 未发布：toast 提示“尚未发布”。

### 管理模式点击逻辑
- 已发布（可订/订完）：弹“发布罡好饭（修改）”，包含：关闭、日期、描述、价格、限制、可选项、修改、撤单、锁定。
  - 可直接修改：仅描述、限制上调（不低于已订）、新增可选项。
  - 需取消重发：改价格、限制下调到低于已订、删除可选项。显示红字提示“此次修改将取消所有已订餐用户的订单”（#DA5234）。对应后端 `POST /meals/{id}/repost`，同一 `meal_id` 下取消并退款所有订单。
- 已锁定：弹“发布罡好饭（已锁定）”，包含：关闭、日期、描述、价格、限制、可选项、修改、撤单、取消锁定。规则同上。
- 已完成：弹“发布罡好饭（只读）”，所有字段锁定。

## 架构调整（2025-08）
- 弹窗组件化：将首页内的“发布/编辑餐次”与“下单/修改”弹窗抽离为独立组件 `publish-dialog` 与 `order-dialog`，页面仅负责状态管理与业务逻辑，降低 `index.ts/wxml` 体积，提升复用性。
- 危险修改与重发：新增后端 `PUT /meals/{id}` 与 `POST /meals/{id}/repost`，前端依据变更类型自动选择调用路径；重发将取消并退款当前餐次的所有有效订单，但不变更 `meal_id`。
- 文案与样式：首页餐次二/三行文本改为“抢饭进行时 / 剩X”，三行文本居中；按新颜色规则为各状态设置明确的前景/背景色。

### 一致性刷新与并发
- 打开弹窗前：先拉取最新餐次详情并刷新日历；若餐次已撤/变更，切换到对应只读态或不弹并提示。
- 关闭弹窗前或操作完成后：再次拉取最新数据并刷新日历。
- 并发提示：若下单过程中餐被锁定，提交时提示“订单状态已改变，请刷新”，并关闭弹窗。

### 后端事务性
- 订单相关操作（下单/修改/撤单/管理员撤销重发）需用单事务包裹“订单变更 + 余额变更 + 已订数量变更”。
- 管理修改需区分直接修改与取消重发；后者需要退款所有已订用户，原餐次置 canceled，新建餐次。

## 代码注释规范
- 详见 doc/comment_std.md

---

遵循以上规范，确保代码的可读性和可维护性，便于团队协作和代码传承。
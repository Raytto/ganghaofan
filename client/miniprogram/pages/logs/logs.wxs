// 日志格式化函数 WXS
var formatTime = function(timeStr) {
  if (!timeStr) return { date: '', time: '' }
  
  var date = getDate(timeStr)
  var year = date.getFullYear()
  var month = (date.getMonth() + 1).toString()
  var day = date.getDate().toString()
  var hours = date.getHours().toString()
  var minutes = date.getMinutes().toString()
  var seconds = date.getSeconds().toString()
  
  // 补零
  month = month.length === 1 ? '0' + month : month
  day = day.length === 1 ? '0' + day : day
  hours = hours.length === 1 ? '0' + hours : hours
  minutes = minutes.length === 1 ? '0' + minutes : minutes
  seconds = seconds.length === 1 ? '0' + seconds : seconds
  
  return {
    date: year + '/' + month + '/' + day,
    time: hours + ':' + minutes + ':' + seconds
  }
}

var formatAction = function(action) {
  var actionMap = {
    'order_create': '下单',
    'order_cancel': '取消订单',
    'order_modify': '修改订单',
    'recharge': '充值',
    'meal_publish': '发布餐次',
    'meal_cancel': '取消餐次',
    'meal_lock': '锁定餐次',
    'meal_unlock': '解锁餐次',
    'meal_complete': '完成餐次',
    'meal_edit': '编辑餐次'
  }
  return actionMap[action] || action
}

var formatOperator = function() {
  return {
    name: '我',
    openid: 'user_***'
  }
}

var formatLogContent = function(action, detail) {
  if (!detail) return '操作详情'
  
  try {
    var parsedDetail = typeof detail === 'string' ? JSON.parse(detail) : detail
    
    switch (action) {
      case 'order_create':
        var amount = (parsedDetail.amount_cents || 0) / 100
        return '订餐：' + (parsedDetail.meal_title || '餐次') + ' - ¥' + amount
      case 'order_cancel':
        var refund = (parsedDetail.refund_cents || 0) / 100
        return '取消订单：' + (parsedDetail.meal_title || '餐次') + ' - 退款¥' + refund
      case 'recharge':
        var rechargeAmount = (parsedDetail.amount_cents || 0) / 100
        return '充值：¥' + rechargeAmount
      case 'meal_publish':
        var slot = parsedDetail.slot === 'lunch' ? '午餐' : '晚餐'
        return '发布餐次：' + (parsedDetail.title || '') + '（' + parsedDetail.date + ' ' + slot + '）'
      case 'meal_cancel':
        var slot = parsedDetail.slot === 'lunch' ? '午餐' : '晚餐'
        return '取消餐次：' + (parsedDetail.title || '') + '（' + parsedDetail.date + ' ' + slot + '）'
      default:
        return JSON.stringify(parsedDetail)
    }
  } catch (e) {
    return detail.toString()
  }
}

module.exports = {
  formatTime: formatTime,
  formatAction: formatAction,
  formatOperator: formatOperator,
  formatLogContent: formatLogContent
}
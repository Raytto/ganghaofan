# 复杂业务流程测试设计文档

## 概述

本文档描述了为罡好饭订餐系统设计的复杂业务流程测试，该测试模拟真实企业订餐环境中的多用户、多情景、高并发场景，特别关注**透支功能**的验证。

## 测试场景：某公司周五订餐高峰期

### 参与角色

| 用户角色 | 特征 | 充值金额 | 测试目的 |
|---------|------|----------|----------|
| **UserA** | 老员工，爱点餐 | 100元 | 测试正常用户行为 |
| **UserB** | 新员工，第一次使用 | 30元 | 测试新用户体验 |
| **UserC** | 挑剔用户，经常改订单 | 80元 | 测试订单修改功能 |
| **UserD** | 穷学生，余额不足 | 5元 | **透支功能核心测试** |
| **UserE** | VIP用户 | 200元 | 测试大额用户行为 |
| **UserF** | 测试用户，零余额 | 0元 | **从零透支测试** |
| **Admin** | 系统管理员 | - | 测试管理员功能 |

### 餐次设计

| 餐次 | 价格 | 容量 | 用途 |
|------|------|------|------|
| **周五特色午餐** | 28元/份 | 20份 | 制造容量竞争，测试抢订 |
| **周五经济晚餐** | 15元/份 | 100份 | 容量充足，测试常规订餐 |

## 测试流程（9个阶段）

### 阶段1: 管理员上午准备工作
- 发布两种不同定价和容量的餐次
- 查看系统统计信息
- 验证餐次发布功能

### 阶段2: 用户上午准备工作  
- **6用户并发充值**，包括零充值用户
- 测试系统在并发充值下的稳定性
- 为后续透支测试做准备

### 阶段3: 午餐高峰期抢订
- **并发下单竞争有限容量**（20份）
- **透支用户大额订餐**：UserD用5元余额订56元餐
- **零余额用户直接透支**：UserF零余额直接订餐
- 验证容量控制和透支功能

### 阶段4: 用户修改订单
- UserC修改配菜选择
- UserA尝试增加订单数量
- 测试订单修改的各种限制

### 阶段5: 管理员危机处理
- 模拟供应商食材问题
- 管理员锁定餐次、查看统计
- 给受影响用户余额补偿
- 验证危机处理流程

### 阶段6: 晚餐替代方案
- 多用户转向订晚餐
- 容量充足场景下的正常订餐
- 测试系统在不同容量下的表现

### **阶段7: 透支压力测试** ⭐
这是专门针对透支功能的核心测试阶段：

#### 透支场景1: 大量透支订餐
- 已透支用户继续订5份晚餐
- 验证深度透支是否被允许

#### 透支场景2: 透支后修改订单
- 从5份增加到8份，增加透支金额
- 验证透支状态下订单修改

#### 透支场景3: 透支订单取消
- 取消大额透支订单
- 验证退款到负余额的处理

#### 透支场景4: 透支用户充值
- 透支用户充值10元
- 验证从负余额恢复的机制

#### 透支场景5: 连续小额透支
- 连续3笔小额订单
- **验证余额计算的准确性**

### 阶段8: 最终危机解决
- 管理员解锁午餐后又取消
- **透支用户的退款处理**
- 验证自动退款机制对透支用户的正确处理

### 阶段9: 最终统计和审计
- 系统统计信息审计
- 交易记录完整性检查
- 生成详细的业务流程报告

## 透支功能关键测试点

### 1. 余额检查绕过
```python
# 检查余额 - 允许负余额（透支）
balance_row = db_manager.execute_one(
    "SELECT balance_cents FROM users WHERE id=?",
    [user_id]
)
balance = balance_row[0] if balance_row else 0

# 注释掉余额检查，允许透支
# if balance < amount:
#     raise InsufficientBalanceError("余额不足")
```

### 2. 测试验证项目

| 验证项目 | 预期结果 | 重要性 |
|---------|----------|---------|
| **余额不足可下单** | ✅ 允许下单 | 🔥 核心功能 |
| **负余额计算准确** | ✅ 数学计算正确 | 🔥 数据一致性 |
| **透支后修改订单** | ✅ 允许修改 | 🔥 用户体验 |
| **透支订单可取消** | ✅ 正确退款 | 🔥 资金安全 |
| **长期透支稳定** | ✅ 系统稳定 | 🔥 系统可靠性 |
| **透支用户充值** | ✅ 余额恢复 | 🔥 财务管理 |

### 3. 边界条件测试

- **深度透支**：余额-100元继续订餐
- **零开始透支**：0元余额直接订餐  
- **批量透支**：连续多笔透支订单
- **透支修改**：增加透支金额
- **透支退款**：退款到更深的负余额

## 业务洞察

### 透支功能价值
1. **用户体验优化**：不因余额不足影响用餐
2. **现金流管理**：允许用户灵活管理资金
3. **业务连续性**：避免因余额问题中断服务
4. **信任机制**：体现对用户的信任

### 系统可靠性验证
1. **数据一致性**：所有透支操作账目清晰
2. **并发安全性**：多用户同时透支不冲突
3. **异常恢复**：透支状态下各种操作正常
4. **审计完整**：所有透支记录可追溯

## 运行方式

### 单独运行复杂业务流程测试
```bash
# 从server目录运行
cd server
./tests/scripts/run_e2e_tests.sh complex
```

### 运行完整测试套件
```bash
# 包含所有测试，包括复杂业务流程
./tests/scripts/run_e2e_tests.sh all
```

## 预期输出

测试成功时会显示详细的业务事件日志，包括：

```
[2024-01-26T10:30:00] UserD: MASSIVE_OVERDRAFT - 大量透支订餐成功 - 订单12345, 金额75.0元, 余额-70.0元
[2024-01-26T10:30:01] TransparentUser: OVERDRAFT_INCREASE - 透支状态下增加订单成功 - 新金额120.0元, 新余额-115.0元
[2024-01-26T10:30:02] TransparentUser: OVERDRAFT_CANCEL - 透支订单取消成功 - 退款后余额5.0元
```

最终报告会显示：
- 16个测试场景全部通过 ✅
- 透支功能各项验证成功 ✅  
- 余额计算准确性确认 ✅
- 系统在透支压力下稳定运行 ✅

这个复杂业务流程测试全面验证了系统在真实业务场景下的可靠性，特别是透支功能的正确性和稳定性。
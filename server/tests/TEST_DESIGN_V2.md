# 端到端测试系统设计方案 V2

## 现有基础分析

### 1. 已有测试框架
- **pytest 测试框架**：`conftest.py` 配置完善
- **测试脚本**：`run_tests.sh` 支持多种测试模式
- **测试分类**：已区分单元测试和API测试

### 2. 身份验证机制
- **模拟认证配置**：`dev_mock.json` 支持开发环境身份模拟
- **环境变量覆盖**：`GHF_MOCK_AUTH` 可动态配置
- **多用户模拟**：`unique_per_login` 选项支持模拟不同用户
- **注意**：服务器运行期间修改 `dev_mock.json` 不会立即生效（有缓存），需通过环境变量或重启服务器

### 3. 数据库管理
- **单实例模式**：使用独立的测试数据库文件，简化管理
- **内存数据库**：测试已支持 `:memory:` 模式

## 设计方案

### 1. 测试身份验证方案

#### 方案概述
- 通过环境变量 `GHF_MOCK_AUTH` 动态设置测试用户
- 使用真实JWT生成逻辑，确保测试贴近生产环境

#### 测试用户配置
```json
{
  "admin_user": {
    "openid": "test_admin_001",
    "nickname": "测试管理员",
    "is_admin": true
  },
  "normal_user_A": {
    "openid": "test_user_001", 
    "nickname": "测试用户A",
    "is_admin": false,
    "initial_balance": 0
  },
  "normal_user_B": {
    "openid": "test_user_002",
    "nickname": "测试用户B",
    "is_admin": false,
    "initial_balance": 0
  },
  "rich_user": {
    "openid": "test_user_003",
    "nickname": "测试用户C",
    "is_admin": false,
    "initial_balance": 10000
  }
}
```

### 2. 测试数据库管理方案

#### 数据库配置
- **测试数据库路径**：`data/test_ganghaofan.duckdb`
- **隔离机制**：使用独立的测试数据库文件，与生产数据库完全隔离
- **Passphrase简化**：Passphrase仅用于简单的熟人验证，不再关联不同数据库实例
- **生命周期管理**：
  - 测试前：自动创建并初始化
  - 测试成功后：删除数据库
  - 测试失败时：保留数据库供调试

#### 数据库初始化流程
1. 创建新的测试数据库文件
2. 执行标准 schema 初始化
3. 验证数据库连接和表结构
4. 不预置数据，所有测试数据通过API操作创建

### 3. 测试用例设计

#### 核心业务流程测试

##### 流程1：完整订餐周期
1. **管理员创建餐次**
   - 创建餐次C（基础价格20元，鸡腿选项3元）
   - 验证餐次创建成功
   - 验证餐次信息正确

2. **用户查看和下单**
   - 用户B（新用户，余额0）查看餐次C
   - 验证餐次信息与创建内容一致
   - 用户B选择鸡腿选项下单
   - 验证订单金额为23元

3. **订单修改流程**
   - 用户B修改订单（取消鸡腿）
   - 验证修改成功，金额变为20元
   - 验证用户余额为-20元

4. **订单锁定机制**
   - 管理员A锁定订单
   - 用户B尝试修改，验证失败
   - 管理员A解锁订单
   - 用户B再次修改（添加鸡腿），验证成功
   - 验证用户余额为-23元

5. **餐次取消与退款**
   - 管理员A取消餐次C
   - 验证用户B订单自动取消
   - 验证用户B余额恢复为0

6. **用户充值**
   - 管理员A给用户B充值100元
   - 验证用户B余额变为100元

#### 补充测试用例

##### 权限验证测试
- 普通用户无法创建餐次
- 普通用户无法锁定订单
- 普通用户无法给他人充值

##### 异常场景测试
- 余额不足时下单（预期：能下单成功，但给出提示）
- 超过餐次容量时下单失败
- 重复下单同一餐次失败
- 无效选项选择失败

##### 数据一致性测试
- 多次修改订单后的余额一致性
- 取消订单后的容量恢复
- 退款时序和余额恢复验证

### 4. 一键测试脚本架构

```bash
test_e2e.sh
│
├── 环境准备阶段
│   ├── 检查依赖（Python、Conda、必要工具）
│   ├── 设置测试环境变量
│   ├── 创建测试数据库
│   └── 启动测试服务器（端口8001）
│
├── 测试执行阶段
│   ├── API基础测试
│   │   ├── 健康检查
│   │   ├── 认证流程
│   │   └── 基础CRUD操作
│   │
│   ├── 业务流程测试
│   │   ├── 完整订餐周期
│   │   ├── 订单修改流程
│   │   └── 退款流程
│   │
│   └── 权限和异常测试
│       ├── 权限验证
│       └── 异常处理
│
└── 环境清理阶段
    ├── 停止测试服务器
    ├── 删除测试数据库（成功时）或保留（失败时）
    ├── 清理临时文件
    └── 恢复环境配置
```

## 测试配置确认

### 1. 测试服务器配置
- **端口选择**：使用独立端口8001
- **并发测试**：第一版不实现

### 2. 数据管理策略
- **数据持久化**：每次测试后完全清空，避免脏数据
- **调试支持**：失败时保留数据库供调试
- **基础数据**：不预置，通过API操作创建

### 3. 测试报告需求
- **报告格式**：纯文本，控制台实时输出
- **详细程度**：只记录报错信息
- **日志文件**：`server/tests/logs/test_run_YYYYMMDD_HHMM.log`

### 4. 测试范围（第一版）
- **并发测试**：暂不实现
- **性能测试**：暂不实现
- **兼容性测试**：暂不实现
- **网络/数据/系统异常**：暂不实现

## 重点测试场景

### 1. 余额相关测试
- 余额不足时的下单行为（预期：能下单，但提示余额不足）
- 多次修改订单后的余额准确性（重点测试）
- 退款时序和余额恢复验证（重点测试）
- 充值操作的一致性（系统不支持并发时可使用锁机制）

### 2. 容量管理测试
- 餐次容量限制验证（重点测试）
- 满容量后的下单拒绝
- 取消订单后的容量释放
- 修改订单数量时的容量调整

### 3. 时间相关测试
- 过期餐次的操作限制
- 订单锁定机制测试（锁定后不可修改）

### 4. 数据完整性测试
- 级联删除的正确性
- 外键约束的有效性
- 事务回滚的完整性

## 实施计划

### 初始阶段：规划设计
- 编写各阶段的详细实施计划文档
- 明确每个阶段的工作方针和预期成果

### 第一阶段：基础架构
- [ ] 实现测试配置管理
- [ ] 简化passphrase逻辑（仅用于验证，不关联数据库）
- [ ] 实现测试数据库初始化
- [ ] 实现测试服务器启动脚本

### 第二阶段：核心测试用例
- [ ] 实现发布餐次测试
- [ ] 实现订餐流程测试
- [ ] 实现充值功能测试
- [ ] 实现权限验证测试
- [ ] 实现基础异常测试

### 第三阶段：高级测试
- [ ] 实现数据一致性测试
- [ ] 实现容量管理测试
- [ ] 实现时间相关测试

### 第四阶段：文档和优化
- [ ] 编写测试使用文档
- [ ] 优化测试执行效率
- [ ] 准备CI/CD集成（后续）

## 测试参数配置

### 环境变量
```bash
# 测试模式开关
TESTING=true

# 测试数据库配置（不再使用passphrase关联）
TEST_DB_PATH=data/test_ganghaofan.duckdb

# 测试服务器配置
TEST_SERVER_PORT=8001
TEST_SERVER_HOST=127.0.0.1

# 测试用户配置
TEST_ADMIN_OPENID=test_admin_001
TEST_USER_A_OPENID=test_user_001
TEST_USER_B_OPENID=test_user_002

# JWT配置
JWT_SECRET_KEY=test-secret-key-for-testing

# Mock认证配置
GHF_MOCK_AUTH='{"mock_enabled": true, "open_id": "test_user", "nickname": "测试用户", "unique_per_login": true}'
```

### 配置文件路径
- 测试配置：`server/tests/config/test_config.json`
- 测试数据：`server/tests/fixtures/` （按需创建）
- 测试日志：`server/tests/logs/test_run_YYYYMMDD_HHMM.log`

## 成功标准

1. **功能覆盖**：覆盖所有核心业务流程（发布餐、订餐、充值）
2. **代码覆盖**：达到80%以上的代码覆盖率
3. **执行时间**：全量测试在5分钟内完成
4. **稳定性**：连续运行10次无随机失败
5. **可维护性**：新增测试用例简单直观

## 风险和缓解措施

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 测试数据污染生产环境 | 高 | 使用独立的数据库文件 |
| 测试服务器端口冲突 | 中 | 使用独立端口8001 |
| 测试执行时间过长 | 中 | 分组执行关键测试 |
| 测试结果不稳定 | 高 | 隔离测试环境，固定随机种子 |
| 依赖服务不可用 | 中 | Mock外部依赖，如微信API |

## 下一步行动

1. **检查并简化passphrase机制**：确保其仅用于验证，不关联数据库实例
2. **编写第一阶段实施计划**：详细规划基础架构搭建
3. **开始实现测试脚本**：从环境准备和基础测试开始
# 端到端测试系统实施计划

## 计划概述

本文档详细规划端到端测试系统的实施，分为四个阶段递进开发：
1. **第一阶段：基础架构** - 搭建测试环境和基础设施
2. **第二阶段：核心测试用例** - 实现关键业务流程测试  
3. **第三阶段：高级测试** - 完善数据一致性和边界测试
4. **第四阶段：文档和优化** - 完善文档，优化性能

## 技术架构

### 测试技术栈
- **测试框架**: pytest + requests
- **数据库**: DuckDB (独立测试数据库)
- **服务器**: FastAPI (测试专用端口8001)
- **认证**: 环境变量Mock + 真实JWT
- **报告**: 控制台输出 + 日志文件

### 目录结构
```
server/tests/
├── config/
│   ├── test_config.json         # 测试配置
│   └── test_users.json          # 测试用户配置
├── fixtures/
│   ├── meal_data.json           # 餐次测试数据模板
│   └── order_scenarios.json    # 订单场景数据
├── e2e/
│   ├── __init__.py
│   ├── base_test.py            # 测试基类
│   ├── test_auth.py            # 认证测试
│   ├── test_meal_crud.py       # 餐次CRUD测试
│   ├── test_order_flow.py      # 订单流程测试
│   ├── test_balance.py         # 余额相关测试
│   └── test_permissions.py     # 权限测试
├── utils/
│   ├── __init__.py
│   ├── test_client.py          # HTTP客户端封装
│   ├── database_manager.py     # 测试数据库管理
│   ├── auth_helper.py          # 认证辅助函数
│   └── data_helper.py          # 测试数据辅助
├── logs/                       # 测试日志目录
├── scripts/
│   ├── setup_test_env.sh       # 测试环境设置
│   ├── run_e2e_tests.sh        # 一键测试脚本
│   └── cleanup_test_env.sh     # 环境清理
└── reports/                    # 测试报告目录 (可选)
```

## 各阶段详细计划

### 第一阶段：基础架构搭建

#### 目标
- 建立稳定的测试环境
- 实现测试数据库管理
- 完成用户认证Mock系统
- 提供基础的测试工具

#### 工作内容

##### 1.1 测试环境配置管理
- **文件**: `tests/config/test_config.json`
- **功能**: 
  - 测试服务器配置 (端口8001)
  - 测试数据库路径配置
  - JWT密钥配置
  - Mock用户配置

##### 1.2 测试数据库管理
- **文件**: `tests/utils/database_manager.py`
- **功能**:
  - 创建独立测试数据库 `test_ganghaofan.duckdb`
  - 自动初始化数据库schema
  - 测试结束后清理/保留数据库
  - 提供数据库重置功能

##### 1.3 认证系统Mock
- **文件**: `tests/utils/auth_helper.py`
- **功能**:
  - 通过环境变量动态设置不同测试用户
  - 生成真实JWT token
  - 提供不同权限级别的用户 (admin/normal)
  - 支持快速用户切换

##### 1.4 HTTP客户端封装
- **文件**: `tests/utils/test_client.py`
- **功能**:
  - 封装requests库，提供统一API
  - 自动添加认证头
  - 统一错误处理和响应解析
  - 支持不同用户身份的请求

##### 1.5 测试服务器管理
- **文件**: `tests/scripts/setup_test_env.sh`
- **功能**:
  - 检查依赖 (Python, conda, 必要包)
  - 设置测试环境变量
  - 启动测试服务器 (端口8001)
  - 验证服务器健康状态

#### 交付标准
- [ ] 测试环境可一键启动和停止
- [ ] 测试数据库能自动创建和清理
- [ ] Mock认证系统能正常工作
- [ ] 基础HTTP客户端能完成API调用
- [ ] 通过健康检查和基础认证测试

#### 预期完成时间
2天

---

### 第二阶段：核心测试用例实现

#### 目标
- 实现完整订餐周期测试
- 覆盖核心业务功能 (发布餐次、订餐、充值)
- 验证权限控制
- 实现基础异常场景测试

#### 工作内容

##### 2.1 餐次管理测试
- **文件**: `tests/e2e/test_meal_crud.py`
- **测试场景**:
  - 管理员创建餐次 (含基础价格和选项)
  - 普通用户查看餐次列表
  - 餐次状态变更 (published → locked → completed)
  - 权限验证 (普通用户不能创建餐次)

##### 2.2 完整订餐流程测试
- **文件**: `tests/e2e/test_order_flow.py`
- **核心场景**:
  ```
  流程1：完整订餐周期
  1. 管理员创建餐次C (20元基础 + 3元鸡腿选项)
  2. 用户B查看餐次并下单 (选择鸡腿，总额23元)
  3. 用户B修改订单 (取消鸡腿，总额20元)
  4. 管理员锁定订单，用户B尝试修改失败
  5. 管理员解锁，用户B重新选择鸡腿 (总额23元)
  6. 管理员取消餐次，订单自动取消，余额退回0
  7. 管理员给用户B充值100元，验证余额更新
  ```

##### 2.3 余额管理测试
- **文件**: `tests/e2e/test_balance.py`
- **测试场景**:
  - 新用户默认余额为0
  - 下单时余额扣减 (支持负余额)
  - 订单修改时的余额调整
  - 订单取消/餐次取消时的退款
  - 管理员充值功能
  - 余额变动明细记录

##### 2.4 权限控制测试
- **文件**: `tests/e2e/test_permissions.py`
- **测试场景**:
  - 普通用户无法创建餐次
  - 普通用户无法锁定/解锁订单
  - 普通用户无法给他人充值
  - 普通用户无法取消他人订单
  - API访问需要有效的passphrase

##### 2.5 异常场景测试
- **集成到各个测试文件中**
- **测试场景**:
  - 余额不足下单 (能下单但有提示)
  - 超过容量限制下单失败
  - 重复下单同一餐次失败
  - 无效选项选择失败
  - 过期餐次操作限制

#### 交付标准
- [ ] 完整订餐周期测试通过
- [ ] 所有核心业务功能测试覆盖
- [ ] 权限控制验证完整
- [ ] 异常场景处理正确
- [ ] 测试执行稳定可重复

#### 预期完成时间
3天

---

### 第三阶段：高级测试完善

#### 目标
- 实现数据一致性测试
- 完善边界条件测试
- 添加容量管理测试
- 增强错误处理验证

#### 工作内容

##### 3.1 数据一致性测试
- **重点验证**:
  - 多次订单修改后余额准确性
  - 订单取消后容量正确释放
  - 级联删除的完整性
  - 事务回滚的有效性
  - 并发操作的数据一致性

##### 3.2 容量管理测试
- **测试场景**:
  - 餐次容量限制验证
  - 满容量后下单拒绝
  - 订单修改时容量调整
  - 批量订单的容量计算

##### 3.3 时间相关测试
- **测试场景**:
  - 过期餐次的操作限制
  - 订单锁定机制验证
  - 创建时间和更新时间记录

##### 3.4 错误恢复测试
- **测试场景**:
  - 数据库操作失败回滚
  - 网络中断后的状态恢复
  - 异常数据的处理

#### 交付标准
- [ ] 数据一致性测试通过
- [ ] 容量管理功能验证完整
- [ ] 时间相关功能正确
- [ ] 错误恢复机制有效

#### 预期完成时间
2天

---

### 第四阶段：文档和优化

#### 目标
- 完善测试文档
- 优化测试执行效率
- 准备CI/CD集成
- 提供使用指南

#### 工作内容

##### 4.1 文档完善
- **测试使用文档**: 如何运行测试、解读结果
- **测试开发文档**: 如何添加新测试用例
- **配置说明文档**: 各项配置的含义和用法
- **故障排查文档**: 常见问题和解决方案

##### 4.2 性能优化
- **并行测试执行**: 独立测试用例并行运行
- **测试数据优化**: 减少数据准备时间
- **资源清理优化**: 快速清理测试环境

##### 4.3 CI/CD准备
- **Docker支持**: 测试环境Docker化
- **GitHub Actions**: 自动化测试流程
- **测试报告**: 结构化测试结果输出

#### 交付标准
- [ ] 文档完整清晰
- [ ] 测试执行时间在5分钟内
- [ ] 支持CI/CD集成
- [ ] 新手能快速上手

#### 预期完成时间
1天

## 总体时间规划

| 阶段 | 预计时间 | 累计时间 | 关键里程碑 |
|------|----------|----------|------------|
| 第一阶段 | 2天 | 2天 | 测试环境可用 |
| 第二阶段 | 3天 | 5天 | 核心功能测试覆盖 |
| 第三阶段 | 2天 | 7天 | 高级测试完善 |
| 第四阶段 | 1天 | 8天 | 文档和优化完成 |

## 风险控制

### 主要风险及应对策略

1. **测试环境不稳定**
   - 风险：测试服务器启动失败或端口冲突
   - 应对：提供端口动态分配，完善环境检查

2. **数据库状态污染**
   - 风险：测试数据影响后续测试
   - 应对：每个测试前后完全清理数据库

3. **Mock认证失效**
   - 风险：认证配置错误导致测试失败
   - 应对：提供多种认证配置方式，详细错误提示

4. **测试执行时间过长**
   - 风险：影响开发效率
   - 应对：分层测试设计，支持快速测试集

### 质量保证措施

1. **代码审查**: 所有测试代码需要review
2. **测试的测试**: 关键测试工具需要有单元测试
3. **文档同步**: 代码变更时同步更新文档
4. **持续集成**: 定期运行完整测试套件

## 成功标准

### 功能性指标
- [ ] 覆盖所有核心业务流程
- [ ] 90%以上的API端点有测试覆盖
- [ ] 权限控制验证完整
- [ ] 异常场景处理正确

### 性能指标
- [ ] 全量测试在5分钟内完成
- [ ] 单个测试用例在10秒内完成
- [ ] 测试环境启动在30秒内

### 可维护性指标
- [ ] 新增测试用例简单直观
- [ ] 测试失败能快速定位问题
- [ ] 配置修改不影响现有测试

### 可靠性指标
- [ ] 连续运行10次无随机失败
- [ ] 不同环境下测试结果一致
- [ ] 测试数据不污染生产环境

## 下一步行动

1. **立即开始第一阶段**：基础架构搭建
2. **每日检查点**：跟踪进度，及时调整计划
3. **阶段验收**：每个阶段完成后进行功能验证
4. **文档先行**：重要组件开发前先设计接口